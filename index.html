<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gæ¤œå®š è‡ªä½œå•é¡Œé›† - å¾©ç¿’&ã‚°ãƒ©ãƒ•æ©Ÿèƒ½</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; max-width: 600px; width: 100%; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        .q-id { color: #007bff; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .q-text { font-size: 1.1em; font-weight: bold; margin-bottom: 20px; line-height: 1.4; }
        .opt-btn { display: block; width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; cursor: pointer; text-align: left; font-size: 16px; transition: 0.2s; }
        .opt-btn:hover:not(:disabled) { background: #f0f0f0; }
        .res-area { margin-top: 15px; padding: 15px; border-radius: 6px; display: none; line-height: 1.6; border: 1px solid #ccc; }
        .correct { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .wrong { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        button.primary-btn { width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .nav-header { display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px; }
        
        /* ã‚°ãƒ©ãƒ•ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #chart-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100; justify-content:center; align-items:center; }
        .chart-modal { background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; text-align:center; }
        
        .badge { font-size: 0.7em; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
        .badge-wrong { background: #dc3545; color: white; }
    </style>
</head>
<body>

<div class="card">
    <div class="nav-header">
        <div class="score-info">å•é¡Œ: <span id="current-count">0</span> / <span id="total-count">0</span></div>
        <div style="display: flex; gap: 5px;">
            <button onclick="toggleChart()" style="font-size: 0.7em; padding: 4px 8px; border-radius: 4px; border: 1px solid #28a745; background: #fff; color: #28a745; cursor: pointer;">æˆç¸¾ã‚°ãƒ©ãƒ•</button>
            <button onclick="resetProgress()" style="font-size: 0.7em; padding: 4px 8px; border-radius: 4px; border: 1px solid #dc3545; background: #fff; color: #dc3545; cursor: pointer;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div id="review-banner" style="display:none; background:#fff3cd; padding:10px; margin-bottom:15px; border-radius:6px; font-size:0.9em; color:#856404; text-align:center;">
        âš ï¸ <strong>ä¸æ­£è§£å•é¡Œã®å¾©ç¿’ä¸­</strong> (<span id="wrong-remaining">0</span>å•)
        <button onclick="exitReview()" style="margin-left:10px; cursor:pointer;">å¾©ç¿’ã‚’çµ‚äº†</button>
    </div>

    <div style="margin-bottom: 20px;">
        <select id="category-jump" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
            <option value="">â–¼ ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ã‚¸ãƒ£ãƒ³ãƒ—</option>
        </select>
    </div>

    <div id="quiz-ui">
        <div id="display-id" class="q-id"></div>
        <div id="display-text" class="q-text">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="options-area"></div>
        <div id="display-result" class="res-area"></div>
        <button id="next-btn" class="primary-btn" style="display:none;">æ¬¡ã®å•é¡Œã¸</button>
        <button id="review-wrong-btn" class="primary-btn" style="display:none; background:#dc3545;">é–“é•ãˆãŸå•é¡Œã ã‘è§£ãç›´ã™</button>
    </div>

    <div id="result-ui" style="display:none; text-align:center;">
        <h2>çµ‚äº†ï¼</h2>
        <p id="final-score" style="font-size: 1.5em; font-weight: bold;"></p>
        <button id="final-review-btn" class="primary-btn" style="background:#dc3545; margin-bottom:10px;">é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’ã™ã‚‹</button>
        <button onclick="resetProgress()" class="primary-btn" style="background:#007bff;">è¨˜éŒ²ã‚’æ¶ˆã—ã¦æœ€åˆã‹ã‚‰è§£ã</button>
    </div>
</div>

<div id="chart-overlay" onclick="toggleChart()">
    <div class="chart-modal" onclick="event.stopPropagation()">
        <h3>ç¾åœ¨ã®æˆç¸¾</h3>
        <canvas id="accuracyChart"></canvas>
        <button onclick="toggleChart()" style="margin-top:15px; padding:8px 20px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    const SAVE_KEY = 'g_kentei_v3_progress';
    let allData = [];
    let currentIdx = 0;
    let correctCount = 0;
    let answeredCount = 0;
    let wrongList = []; // ä¸æ­£è§£å•ã®IDãƒªã‚¹ãƒˆ
    let isReviewMode = false;
    let reviewIdx = 0;
    let myChart = null;

    fetch('quizData.json')
        .then(res => res.json())
        .then(data => {
            allData = data;
            document.getElementById('total-count').innerText = allData.length;
            generateCategoryMenu(data);
            loadProgress();
            showQuestion();
        });

    function generateCategoryMenu(data) {
        const select = document.getElementById('category-jump');
        const categories = [...new Set(data.map(item => item.Category))];
        categories.forEach(cat => {
            const firstIdx = data.findIndex(item => item.Category === cat);
            const option = document.createElement('option');
            option.value = firstIdx;
            option.innerText = cat;
            select.appendChild(option);
        });
        select.onchange = (e) => {
            if(e.target.value !== "") {
                isReviewMode = false;
                currentIdx = parseInt(e.target.value);
                saveProgress();
                showQuestion();
            }
        };
    }

    function showQuestion() {
        const item = isReviewMode ? allData.find(d => d.ID === wrongList[reviewIdx]) : allData[currentIdx];
        if (!item) return exitReview();

        document.getElementById('review-banner').style.display = isReviewMode ? 'block' : 'none';
        if(isReviewMode) document.getElementById('wrong-remaining').innerText = wrongList.length - reviewIdx;

        document.getElementById('current-count').innerText = isReviewMode ? "å¾©ç¿’" : currentIdx + 1;
        document.getElementById('display-id').innerText = `[${item.Category}] ${item.ID}`;
        document.getElementById('display-text').innerText = item.Question;
        document.getElementById('display-result').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        
        const optArea = document.getElementById('options-area');
        optArea.innerHTML = '';
        const options = item.options || [item.Opt1, item.Opt2, item.Opt3, item.Opt4, item.Opt5, item.Opt6].filter(v => v);

        options.forEach((txt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = txt;
            btn.onclick = () => checkAnswer(idx, item);
            optArea.appendChild(btn);
        });
    }
function checkAnswer(idx, item) {
        const resArea = document.getElementById('display-result');
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(b => b.disabled = true);

        const isCorrect = (idx === item.Answer_Idx);
        if (isCorrect) {
            if(!isReviewMode) correctCount++;
            resArea.className = 'res-area correct';
            resArea.innerHTML = `<strong>âœ¨ æ­£è§£ï¼</strong><br>${item.Explanation}`;
        } else {
            resArea.className = 'res-area wrong';
            const options = item.options || [item.Opt1, item.Opt2, item.Opt3, item.Opt4, item.Opt5, item.Opt6].filter(v => v);
            resArea.innerHTML = `<strong>âŒ ä¸æ­£è§£...</strong> (æ­£è§£: ${options[item.Answer_Idx]})<br>${item.Explanation}`;
            if(!wrongList.includes(item.ID)) wrongList.push(item.ID);
        }

        // --- ä»Šå›ã®ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šJSONã®Linkã‚’ç„¡è¦–ã—ã¦Googleæ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ä½œæˆ ---
        // æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ã€ŒGæ¤œå®š ï¼‹ å•é¡Œæ–‡ã€ã«ã—ã¦ç²¾åº¦ã‚’é«˜ã‚ã¾ã™
        const searchQuery = encodeURIComponent("Gæ¤œå®š " + item.Question);
        const searchUrl = `https://www.google.com/search?q=${searchQuery}`;
        
        resArea.innerHTML += `<br><a href="${searchUrl}" target="_blank" class="link-btn" style="background:#4285F4;">ğŸ” Googleã§ã“ã®å•é¡Œã‚’æ¤œç´¢ (åˆ¥ã‚¿ãƒ–)</a>`;
        // ------------------------------------------------------------------

        if(!isReviewMode) answeredCount++;
        resArea.style.display = 'block';
        document.getElementById('next-btn').style.display = 'block';
        if(!isReviewMode && wrongList.length > 0) document.getElementById('review-wrong-btn').style.display = 'block';
        saveProgress();
    }
    document.getElementById('next-btn').onclick = () => {
        document.getElementById('review-wrong-btn').style.display = 'none';
        if (isReviewMode) {
            reviewIdx++;
            if (reviewIdx < wrongList.length) showQuestion();
            else exitReview();
        } else {
            currentIdx++;
            if (currentIdx < allData.length) showQuestion();
            else showFinalResult();
        }
    };

    function startReview() {
        if(wrongList.length === 0) return alert("å¾©ç¿’ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼");
        isReviewMode = true;
        reviewIdx = 0;
        document.getElementById('result-ui').style.display = 'none';
        document.getElementById('quiz-ui').style.display = 'block';
        showQuestion();
    }

    document.getElementById('review-wrong-btn').onclick = startReview;
    document.getElementById('final-review-btn').onclick = startReview;

    function exitReview() {
        isReviewMode = false;
        alert("é€šå¸¸ã®å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚");
        showQuestion();
    }

    // ã‚°ãƒ©ãƒ•è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
    function toggleChart() {
        const overlay = document.getElementById('chart-overlay');
        if (overlay.style.display === 'flex') {
            overlay.style.display = 'none';
        } else {
            overlay.style.display = 'flex';
            renderChart();
        }
    }

    function renderChart() {
        const ctx = document.getElementById('accuracyChart').getContext('2d');
        const rate = answeredCount > 0 ? Math.round((correctCount/answeredCount)*100) : 0;
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['æ­£è§£', 'ä¸æ­£è§£'],
                datasets: [{
                    data: [correctCount, answeredCount - correctCount],
                    backgroundColor: ['#28a745', '#dc3545']
                }]
            },
            options: {
                plugins: {
                    title: { display: true, text: `ç´¯ç©æ­£è§£ç‡: ${rate}% (å›ç­”æ•°: ${answeredCount})` }
                }
            }
        });
    }

    function saveProgress() {
        const data = { index: currentIdx, correct: correctCount, answered: answeredCount, wrongs: wrongList };
        localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    }

    function loadProgress() {
        const saved = localStorage.getItem(SAVE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            currentIdx = data.index || 0;
            correctCount = data.correct || 0;
            answeredCount = data.answered || 0;
            wrongList = data.wrongs || [];
        }
    }

    function resetProgress() {
        if (confirm("å…¨ã¦ã®è¨˜éŒ²ï¼ˆä¸æ­£è§£ãƒªã‚¹ãƒˆå«ã‚€ï¼‰ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem(SAVE_KEY);
            location.reload();
        }
    }

    function showFinalResult() {
        document.getElementById('quiz-ui').style.display = 'none';
        document.getElementById('result-ui').style.display = 'block';
        document.getElementById('final-score').innerText = `${allData.length}å•ä¸­ ${correctCount}å•æ­£è§£ï¼`;
        document.getElementById('final-review-btn').style.display = wrongList.length > 0 ? 'block' : 'none';
    }
</script>
</body>
</html>
